{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}
{% block body_class %}page-dashboard{% endblock %}
{% block header %}{% include 'components/navbar.html' %}{% endblock %}
{% block content %}
<div class="dashboard-content">
    <h1>{{ page_title }}</h1>
    {% if videos %}
        <div class="video-grid">
        {% for video in videos %}
            <div class="card video-card">
                <a href="https://youtube.com/watch?v={{ video.id }}" target="_blank" class="video-thumbnail">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
                    <div class="video-overlay">
                        <span class="play-icon">▶</span>
                    </div>
                </a>
                <div class="video-info">
                    <div class="video-header">
                        <h3 class="video-title">{{ video.title[:60] }}{% if video.title|length > 60 %}...{% endif %}</h3>
                        <button class="favorite-btn {% if video.id in favorite_ids %}active{% endif %}" 
                                data-video-id="{{ video.id }}" 
                                data-title="{{ video.title }}"
                                data-channel="{{ video.channel }}"
                                data-description="{{ video.description }}"
                                data-thumbnail="{{ video.thumbnail }}"
                                title="{% if video.id in favorite_ids %}Quitar de favoritos{% else %}Agregar a favoritos{% endif %}">
                            {% if video.id in favorite_ids %}★{% else %}☆{% endif %}
                        </button>
                    </div>
                    <p class="video-channel">{{ video.channel }}</p>
                    <p class="video-description">{{ video.description[:100] }}{% if video.description|length > 100 %}...{% endif %}</p>
                </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <p>No hay videos disponibles. {% if page_title == 'Búsqueda' %}Intenta con otra búsqueda.{% elif page_title == 'Favoritos' %}Aún no has agregado videos a favoritos.{% else %}Configura tu YouTube API Key.{% endif %}</p>
    {% endif %}
</div>

<script>
// ============================================
// SISTEMA DE FAVORITOS
// ============================================
document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const videoId = this.dataset.videoId;
        const videoData = {
            title: this.dataset.title,
            channel: this.dataset.channel,
            description: this.dataset.description,
            thumbnail: this.dataset.thumbnail
        };
        
        console.log('Toggle favorito para video:', videoId);
        
        try {
            const response = await fetch(`/toggle-favorite/${videoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(videoData)
            });
            
            if (response.ok) {
                // Cambiar el estado visual
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                this.textContent = isActive ? '★' : '☆';
                this.title = isActive ? 'Quitar de favoritos' : 'Agregar a favoritos';
                
                // Mostrar mensaje
                console.log(isActive ? 'Agregado a favoritos' : 'Eliminado de favoritos');
            } else {
                console.error('Error en la respuesta:', response.status);
                alert('Error al actualizar favoritos');
            }
        } catch (error) {
            console.error('Error al toggle favorito:', error);
            alert('Error de conexión. Intenta de nuevo.');
        }
    });
});
</script>
{% endblock %}