{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
.captcha-box {
    background: #121212;
    border: 2px solid #ffb700;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    text-align: center;
}

.captcha-question {
    font-size: 1.2rem;
    color: #ffb700;
    font-weight: 700;
    margin-bottom: 10px;
}

.captcha-input {
    width: 100px !important;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
}

.validation-hint {
    font-size: 0.85rem;
    color: #888;
    margin-top: 5px;
}

.input-group input:invalid:not(:placeholder-shown) {
    border-color: #f44336;
}

.input-group input:valid:not(:placeholder-shown) {
    border-color: #4caf50;
}

.requirements-list {
    background: #1a1a1a;
    border-left: 3px solid #ffb700;
    padding: 12px 15px;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.requirements-list ul {
    margin: 5px 0 0 20px;
    padding: 0;
    color: #aaa;
}

.requirements-list li {
    margin: 3px 0;
}
</style>
{% endblock %}
{% block body_class %}page-login{% endblock %}
{% block content %}
<div class="login-container">
    <div class="brand-logo">TUT<span>0</span>HUB</div>
    <h2>Crear Cuenta</h2>
    
    <div class="requirements-list">
        <strong style="color: #ffb700;">Requisitos:</strong>
        <ul>
            <li>Usuario: 3-80 caracteres (letras, números, - _)</li>
            <li>Email: Formato válido</li>
            <li>Contraseña: Mínimo 8 caracteres, incluir letras y números</li>
        </ul>
    </div>
    
    <form method="POST" id="registerForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Usuario -->
        <div class="input-group">
            <label for="username">Usuario *</label>
            <input type="text" 
                   id="username" 
                   name="username" 
                   required 
                   minlength="3" 
                   maxlength="80" 
                   pattern="[A-Za-z0-9_\-]+"
                   placeholder="Ej: juan_perez123"
                   title="Solo letras, números, guiones y guiones bajos">
            <span class="validation-hint">3-80 caracteres</span>
        </div>
        
        <!-- Email -->
        <div class="input-group">
            <label for="email">Email *</label>
            <input type="email" 
                   id="email" 
                   name="email" 
                   required 
                   maxlength="120"
                   placeholder="tu@email.com"
                   title="Introduce un email válido">
            <span class="validation-hint">Formato: usuario@dominio.com</span>
        </div>
        
        <!-- Contraseña -->
        <div class="input-group">
            <label for="password">Contraseña *</label>
            <input type="password" 
                   id="password" 
                   name="password" 
                   required 
                   minlength="8" 
                   maxlength="255"
                   placeholder="Mínimo 8 caracteres"
                   title="Mínimo 8 caracteres, debe incluir letras y números">
            <span class="validation-hint">Mínimo 8 caracteres con letras y números</span>
        </div>
        
        <!-- Confirmar Contraseña -->
        <div class="input-group">
            <label for="password_confirm">Confirmar Contraseña *</label>
            <input type="password" 
                   id="password_confirm" 
                   name="password_confirm" 
                   required 
                   minlength="8"
                   placeholder="Repite tu contraseña"
                   title="Debe coincidir con la contraseña">
            <span class="validation-hint">Debe coincidir con la contraseña</span>
        </div>
        
        <!-- CAPTCHA -->
        <div class="captcha-box">
            <div class="captcha-question"> Verificación </div>
            <p style="color: #fff; margin: 10px 0;">{{ captcha_question }}</p>
            <input type="number" 
                   name="captcha_answer" 
                   class="captcha-input"
                   required 
                   placeholder="?"
                   title="Responde la operación matemática"
                   autocomplete="off">
        </div>
        
        <button type="submit" class="btn-primary">REGISTRARSE</button>
    </form>
    
    <p>¿Ya tienes cuenta? <a href="{{ url_for('auth.login') }}">Inicia sesión</a></p>
</div>

<script>
// Validaciones en FrontEnd con JavaScript
document.getElementById('registerForm').addEventListener('submit', function(e) {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('password_confirm').value;
    const captcha = document.querySelector('[name="captcha_answer"]').value;
    
    // Validar todos los campos estén llenos
    if (!username || !email || !password || !passwordConfirm || !captcha) {
        e.preventDefault();
        alert('Todos los campos son obligatorios');
        return false;
    }
    
    // Validar longitud de usuario
    if (username.length < 3 || username.length > 80) {
        e.preventDefault();
        alert('El usuario debe tener entre 3 y 80 caracteres');
        return false;
    }
    
    // Validar caracteres de usuario
    const usernamePattern = /^[A-Za-z0-9_\-]+$/;
    if (!usernamePattern.test(username)) {
        e.preventDefault();
        alert('El usuario solo puede contener letras, números, guiones y guiones bajos');
        return false;
    }
    
    // Validar email
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
        e.preventDefault();
        alert('Introduce un email válido');
        return false;
    }
    
    // Validar longitud de contraseña
    if (password.length < 8) {
        e.preventDefault();
        alert('La contraseña debe tener al menos 8 caracteres');
        return false;
    }
    
    // Validar que contraseña tenga letras
    if (!/[A-Za-z]/.test(password)) {
        e.preventDefault();
        alert('La contraseña debe contener al menos una letra');
        return false;
    }
    
    // Validar que contraseña tenga números
    if (!/[0-9]/.test(password)) {
        e.preventDefault();
        alert('La contraseña debe contener al menos un número');
        return false;
    }
    
    // Validar que contraseña no sea igual al usuario
    if (password.toLowerCase() === username.toLowerCase()) {
        e.preventDefault();
        alert('La contraseña no puede ser igual al usuario');
        return false;
    }
    
    // Validar que las contraseñas coincidan
    if (password !== passwordConfirm) {
        e.preventDefault();
        alert('Las contraseñas no coinciden');
        document.getElementById('password_confirm').focus();
        return false;
    }
    
    // Validar CAPTCHA no esté vacío
    if (!captcha) {
        e.preventDefault();
        alert('Por favor, resuelve el CAPTCHA');
        return false;
    }
    
    return true;
});

// Validación en tiempo real de coincidencia de contraseñas
document.getElementById('password_confirm').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const passwordConfirm = this.value;
    
    if (passwordConfirm && password !== passwordConfirm) {
        this.setCustomValidity('Las contraseñas no coinciden');
    } else {
        this.setCustomValidity('');
    }
});

// Validación en tiempo real de usuario
document.getElementById('username').addEventListener('input', function() {
    const pattern = /^[A-Za-z0-9_\-]+$/;
    if (this.value && !pattern.test(this.value)) {
        this.setCustomValidity('Solo letras, números, guiones y guiones bajos');
    } else {
        this.setCustomValidity('');
    }
});
</script>
{% endblock %}